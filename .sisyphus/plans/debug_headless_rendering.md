# Debug Headless Rendering & Component Initialization

## Context
**User Request**: The user wants to see the `robot-model` and `teleop-dashboard` components in the screenshot generated by the headless browser test. Previous attempts resulted in an empty grey screen or only basic primitives (red box) working. The hypothesis is that custom components are failing to register, initialize, or are encountering JS/Network errors in the headless environment.

**Metis Review Findings**:
- **Diagnostic Priority**: We must distinguish between "Engine Loaded" (AFRAME exists), "Scene Loaded" (DOM ready), "Components Registered" (JS loaded), and "Assets Loaded" (Network/GLTF).
- **Instrumentation**: The test must capture and print browser console logs, page errors, and network failures to the terminal.
- **Clean Fallback**: Instead of modifying source code (`index.html`), we will inject the debug "Green Box" dynamically using Playwright's `page.evaluate`.
- **Assertion Strategy**: Verification must be programmatic (checking `AFRAME.components`), not just visual.

## Task Dependency Graph

| Task | Depends On | Reason |
|------|------------|--------|
| Task 1 | None | Initial exploration to identify test commands |
| Task 2 | Task 1 | Modifies the test file identified in Task 1 |
| Task 3 | Task 2 | Executes the modified test to generate diagnostics |
| Task 4 | Task 3 | Analyzes logs to determine the root cause (Fix Phase) |

## Parallel Execution Graph

**Sequential Execution Required**: This is a linear debugging process. We must modify the test, run it, and analyze the output before attempting any fixes.

Wave 1:
└── Task 1: Identify Test Command & Structure

Wave 2:
└── Task 2: Instrument `tests/final_verification.spec.ts`

Wave 3:
└── Task 3: Execute & Analyze

## Tasks

### Task 1: Identify Test Command & Structure
**Description**: Check `package.json` and `playwright.config.ts` (if exists) to determine the exact command to run the verification test.
**Delegation Recommendation**:
- Category: `quick` - Simple file read/search.
- Skills: [`unspecified-low`] - No special skills needed.
**Skills Evaluation**:
- OMITTED `playwright`: Not running tests yet, just checking config.
**Acceptance Criteria**:
- [ ] Confirmed command to run `tests/final_verification.spec.ts` (e.g., `npm run test:e2e` or `npx playwright test ...`).
- [ ] Confirmed URL/Path the test visits (localhost vs file://).

### Task 2: Instrument `tests/final_verification.spec.ts`
**Description**: Modify the Playwright test file to add aggressive logging and diagnostic checks.
**Specific Modifications**:
1.  **Console/Error Listeners**: Add `page.on('console')`, `page.on('pageerror')`, `page.on('requestfailed')` to print to terminal.
2.  **Scene Wait**: Add `await page.waitForSelector('a-scene', { state: 'attached' })`.
3.  **Dynamic Green Box**: Inject a green box via `page.evaluate` to `0 1.5 -2` as a rendering baseline (avoids editing `index.html`).
4.  **Component Dump**: Evaluate and log `Object.keys(window.AFRAME.components)` after scene load.
5.  **Entity Check**: Log if `document.querySelector('robot-model')` (or equivalent selector) exists and has `components` attached.
**Delegation Recommendation**:
- Category: `quick` - Modifying a single test file.
- Skills: [`typescript-programmer`] - Writing Playwright TS code.
**Skills Evaluation**:
- INCLUDED `typescript-programmer`: Editing TS test file.
- OMITTED `playwright`: We are *editing* the file, not *running* it yet (though the code is for playwright).
**Depends On**: Task 1
**Acceptance Criteria**:
- [ ] Test file contains console/pageerror listeners.
- [ ] Test file contains `page.evaluate` script to inject green box.
- [ ] Test file contains logic to dump `AFRAME.components`.

### Task 3: Execute & Analyze
**Description**: Run the instrumented test and capture the output.
**Delegation Recommendation**:
- Category: `quick` - Running a command.
- Skills: [`playwright`] - Running the browser test.
**Skills Evaluation**:
- INCLUDED `playwright`: To execute the test and handle browser interactions if needed.
**Depends On**: Task 2
**Acceptance Criteria**:
- [ ] Test command executed.
- [ ] Terminal output captured containing "PAGE LOG:", "PAGE ERROR:", or component lists.
- [ ] Screenshot generated (location confirmed).

### Task 4: Fix (Conditional - Component Registration)
**Description**: If Task 3 reveals that `robot-model` is NOT in `AFRAME.components`, we must ensure it is imported.
**Action**: Check `webxr/src/index.ts` (or entry point) and ensure `import './systems/robot_model';` (or similar) exists. If missing, add it.
**Delegation Recommendation**:
- Category: `quick` - Simple import addition.
- Skills: [`typescript-programmer`] - Editing source code.
**Depends On**: Task 3
**Acceptance Criteria**:
- [ ] Component file is imported in the application entry point.

## Commit Strategy
- **Diagnostic Phase**: No commit needed (debugging).
- **Fix Phase**: If Task 4 modifies code:
    - Message: `fix(webxr): ensure robot-model component is imported`
    - Files: `webxr/src/index.ts`

## Success Criteria
- [ ] Terminal logs clearly show whether `robot-model` is registered or not.
- [ ] Screenshot shows Green Box (proving WebGL works).
- [ ] Screenshot shows Robot Model (after fix) OR logs explain why it's missing (e.g., 404 on model file).
